<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      xmlns:i18n="http://xml.zope.org/namespaces/i18n"
      lang="en"
      metal:use-macro="context/main_template/macros/master"
      tal:define="members view/members;
                  skills view/skills;
                  memberorder python:view.memberorder(members);
                  dummy python:view.set_column_totals(memberorder);
                  current_properties view/current_properties|nothing;
                  current_id current_properties/id|nothing;
                  expertise python:'';
                  exp_group python:'';
                  empty_count python:0;
                  update_count python:0;
                  total python:0;"
      i18n:domain="plone">

<head>
    <metal:block fill-slot="top_slot"
                 tal:define="dummy python:request.set('disable_border',1);
                             disable_column_one python:request.set('disable_plone.leftcolumn',1);
                             disable_column_two python:request.set('disable_plone.rightcolumn',1);" />
</head>

<body>
<metal:content-core fill-slot="content-core">
  <metal:content-core define-macro="content-core">
    <style>
      <metal:style use-macro="view/context/@@knowledge-utils/style"/>
      <metal:full use-macro="view/context/@@knowledge-utils/full"/>
    </style>

    <div class="table-wrap" i18n:domain="vs.knowledge">
      <table class="legend">
        <thead>
          <tr>
            <th colspan="2" i18n:translate="">Legend</th>
          </tr>
        </thead>
        <tbody>
          <tr tal:repeat="level python:[l.split('|') for l in context.levels if not l.startswith('|')]">
            <th tal:content="python:level[1]">Title</th>
            <td>
              <span tal:content="value"
                    tal:define="value python:level[0]"
                    tal:attributes="class string:level-${value}">0</span>
            </td>
          </tr>
        </tbody>
      </table>

      <metal:links use-macro="view/context/@@knowledge-utils/links"/>

      <table class="knowledge full">
        <thead>
          <tr>
            <th i18n:translate="">Expertise</th>
            <th i18n:translate="">Subgroup</th>
            <th i18n:translate="">Name</th>
            <th i18n:translate="">Searchterms</th>
            <tal:cteam repeat="cteam python:sorted(members.keys())">
              <th tal:repeat="member python:members[cteam]"
                  tal:attributes="class python:'employee %s' % cteam">
                <span tal:content="python:member.getProperty('fullname')">Fullname</span>
              </th>
            </tal:cteam>
            <th>&nbsp;</th>
          </tr>
        </thead>
        <tbody>
          <tr tal:repeat="skill skills">
            <tal:headers define="group skill/group|nothing;
                                 expertise_group python:group.split('|');
                                 xp python:expertise_group[0] if len(expertise_group) == 2 else '';
                                 gr python:expertise_group[1] if len(expertise_group) == 2 else ''">
              <th tal:define="show python:expertise != xp"
                  tal:attributes="class python:None if show else 'blank';"
                  tal:content="python:xp if show else ''">Expertise</th>
              <tal:expertise define="global expertise xp"/>
              <th tal:define="show python:exp_group != gr"
                  tal:attributes="class python:None if show else 'blank';"
                  tal:content="python:gr if show else ''">Group</th>
              <tal:exp_group define="global exp_group gr"/>
              <th tal:content="skill/title|nothing"></th>
              <th tal:content="skill/description|nothing"></th>
            </tal:headers>
            <tal:data define="mls skill/member_level_show|nothing; 
                              data python:dict([(x.split('|')[0], x.split('|')[1]) for x in mls if len(x.split('|')) == 3]);
                              row_total python:0;
                              delta python:0;
                              group_lengths python:[len(o[1]) for o in memberorder];">
              <tal:cteam repeat="ct memberorder">
                <td tal:repeat="member members"
                    tal:attributes="class python:'%s current-member' % cteam if member == current_id else cteam;"
                    tal:define="cteam python:ct[0];
                                members python:ct[1];">
                  <tal:value define="value python:data.get(member, False);
                                     i python:repeat['member'].index + delta;">
                    <span tal:content="value"
                          tal:define="value python:value if value else ''"
                          tal:attributes="class string:level-${value}">0</span>
                    <!-- <span tal:content="python:(i, value)"/> -->
                    <tal:current_count 
                      condition="python:member == current_id"
                      define="x_val python:value in ['x', 'X'];
                              e_val python:value == False;
                              no_val python:value == '';
                              num_val python:not (x_val or e_val or no_val);
                              amount python:num_val and int(value) or x_val and 1 or 0;
                              global row_total python:row_total + amount;
                              dummy python:view.update_column_totals(i, amount);">
                      <tal:e condition="e_val"><tal:empty define="global empty_count python:empty_count + 1"/></tal:e>
                      <tal:x condition="x_val">
                        <tal:update define="global update_count python:update_count + 1"/>
                      </tal:x>
                    </tal:current_count>
                  </tal:value>
                </td>
                <tal:update define="global delta python:delta + group_lengths[repeat['ct'].index];"/>
              </tal:cteam>
              <td class="total" tal:content="row_total"
                  tal:define="global total python:total + row_total">123</td>
            </tal:data>
          </tr>
          <tr>
            <th>Total</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
            <th>&nbsp;</th>
            <td tal:repeat="column_total view/column_totals"
                tal:content="column_total"
                class="total"></td>
            <td tal:content="total"
                class="total"></td>
          </tr>
        </tbody>
      </table>

      <metal:actions use-macro="view/context/@@knowledge-utils/actions"/>
    </div>
  </metal:content-core>
</metal:content-core>
</body>
</html>
